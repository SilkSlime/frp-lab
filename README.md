# FRP mTLS LAB üõ°Ô∏è

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è–µ–º–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∞—è  
–∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å **frps ‚Üî frpc** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **–≤–∑–∞–∏–º–Ω—É—é TLS-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é**  
(–∫–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–µ–¥—ä—è–≤–ª—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –≤–∞—à–∏–º CA).

* **–ë–µ–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞** ‚Äî –æ–±–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∂–∏–≤—É—Ç –≤ –æ–±—â–µ–π `bridge`-—Å–µ—Ç–∏ `frpnet`
* **–ú–∏–Ω–∏–º—É–º –æ–±—Ä–∞–∑–æ–≤** ‚Äî `snowdreamtech/frps`, `snowdreamtech/frpc` –∏ –≥–æ—Ç–æ–≤—ã–π echo-backend
* **–û–¥–Ω–æ–∫–Ω–æ–ø–æ—á–Ω–∞—è PKI** ‚Äî —Å–∫—Ä–∏–ø—Ç `frpgen` üîê —Å–æ–∑–¥–∞—ë—Ç CA –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —É–∑–ª—ã

---

## 1. –ì–µ–Ω–µ—Ä–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

### –ö–æ—Ä–Ω–µ–≤–æ–π CA  (–ø–∞–ø–∫–∞ certs –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞)
```bash
./frpgen root certs --overwrite
```

### –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ (CN = server, SAN=DNS:server)
```bash
./frpgen client certs/server --ca certs
```

### –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–ª–∏–µ–Ω—Ç–∞  (CN = client, SAN=DNS:client)
```bash
./frpgen client certs/client --ca certs
```

> –í–∞–∂–Ω–æ
>
> * `CN` = –∏–º—è, –∫–æ—Ç–æ—Ä—ã–º –∑–∞—Ç–µ–º –ø–æ–ª—å–∑—É–µ–º—Å—è –≤ TLS-–ø—Ä–æ–≤–µ—Ä–∫–µ
> * `frpgen` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç **SAN**.
>   –î–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ `server` —ç—Ç–æ `DNS:server`, –ø–æ—ç—Ç–æ–º—É –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∫–ª–∏–µ–Ω—Ç–∞
>   `transport.tls.serverName = "server"`.

–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∏–ª–∏—Å—å:

```
certs/
  FRP_CA.crt            # –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ—Ä–µ–Ω—å ‚Äì —Ä–∞–∑–¥–∞—ë—Ç—Å—è –≤—Å–µ–º
  FRP_CA.key            # –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á CA (—Ö—Ä–∞–Ω–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ!!)
  server/
      server.crt
      server.key
  client/
      client.crt
      client.key
```

---

## 2. –ó–∞–ø—É—Å–∫–∞–µ–º frps

```bash
cd frps
docker compose up -d
```

*–û—Ç–∫—Ä–æ–µ—Ç –ø–æ—Ä—Ç—ã only:* **7000/tcp** (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π, –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏)
–∏ **9003/tcp** (–Ω–∞—à –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å-—ç—Ö–æ).

–°–æ—Å—Ç–∞–≤ `frps.toml` (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã):

```toml
bindPort = 7000                     # –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª

transport.tls.force = true          # –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¢–û–õ–¨–ö–û TLS
transport.tls.certFile      = "/etc/frp/certs/frps.crt"
transport.tls.keyFile       = "/etc/frp/certs/frps.key"
transport.tls.trustedCaFile = "/etc/frp/certs/CA.crt"

allowPorts = [ { single = 9003 } ]  # –∫–ª–∏–µ–Ω—Ç—É —Ä–∞–∑—Ä–µ—à—ë–Ω —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω remotePort
```

---

## 3. –ó–∞–ø—É—Å–∫–∞–µ–º frpc + backend

```bash
cd ../frpc
docker compose up -d
```

### –ß—Ç–æ —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

| —Å–µ—Ä–≤–∏—Å      | —Ä–æ–ª—å                                                                              | –ø–æ—Ä—Ç |
| ----------- | --------------------------------------------------------------------------------- | ---- |
| **backend** | –≥–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑ `mendhak/http-https-echo:29`<br>—Å–ª—É—à–∞–µ—Ç `8080/tcp` –∏ –æ—Ç–¥–∞—ë—Ç JSON    | 8080 |
| **frpc**    | —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç mTLS-—Ç—É–Ω–Ω–µ–ª—å –∫ `frps:7000`,<br>—Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç `local 8080 ‚Üí remote 9003` | ‚Äì    |

`frpc.toml` –∫–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏:

```toml
serverAddr = "frps"           # DNS-alias –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞
...
transport.tls.serverName = "server"   # –î–û–õ–ñ–ï–ù —Å–æ–≤–ø–∞—Å—Ç—å —Å CN –≤ server.crt
```

---

## 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º

| –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å  | –∫–æ–º–∞–Ω–¥–∞                                                    | —Ä–µ–∑—É–ª—å—Ç–∞—Ç                              |
| ---------------- | ---------------------------------------------------------- | -------------------------------------- |
| –°–µ—Ä–≤–∏—Å —á–µ—Ä–µ–∑ FRP | `curl http://127.0.0.1:9003`                               | JSON-—ç—Ö–æ                               |
| Dashboard        | –±—Ä–∞—É–∑–µ—Ä ‚Üí `http://127.0.0.1:7500`<br>–ª–æ–≥–∏–Ω **admin/admin** | –≤–∏–¥–∏–º 1 –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏, mTLS = `true` |

–ï—Å–ª–∏ —É–±—Ä–∞—Ç—å —É –∫–ª–∏–µ–Ω—Ç–∞ `client.crt`, frps –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ä–∞–∑–æ—Ä–≤—ë—Ç handshake –∏ –ª–æ–≥ –ø–æ–∫–∞–∂–µ—Ç
`bad certificate`.

---

## –†–∞–∑–±–æ—Ä –∫–æ–Ω—Ñ–∏–≥–æ–≤

### `frps/compose.yml`

| —Å–µ–∫—Ü–∏—è      | –∑–∞—á–µ–º                                          |
| ----------- | ---------------------------------------------- |
| `volumes:`  | –º–æ–Ω—Ç–∏—Ä—É–µ–º certs –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞              |
| `ports:`    | 7500 (dashboard)<br>9003 (echo-—Å–µ—Ä–≤–∏—Å)         |
| `networks:` | –æ–±–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ `frpnet` ‚áí –Ω–µ –Ω—É–∂–µ–Ω publish 7000 (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ—Ä—Ç `7000` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∫–ª–∏–µ–Ω—Ç—É –∏ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç) |

### `frpc/compose.yml`

| —Å–µ—Ä–≤–∏—Å      | –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                                                     |
| ----------- | --------------------------------------------------------------- |
| **frpc**    | `volumes:` ‚Äî —Å–≤–æ–π .toml + client certs<br>`depends_on: backend` |
| **backend** | –≥–æ—Ç–æ–≤—ã–π echo-–æ–±—Ä–∞–∑                        |

### –ü–æ–ª–µ `transport.tls.serverName`

* –ö–ª–∏–µ–Ω—Ç –≤–æ –≤—Ä–µ–º—è TLS-handshake –ø–æ—Å—ã–ª–∞–µ—Ç **SNI = "server"**
* OpenSSL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —ç—Ç–æ —Å–æ–≤–ø–∞–ª–æ —Å **SAN DNS\:server** –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ frps
* –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–ª–æ ‚Äî `tls: bad certificate`.

---

## –ß—Ç–æ –ø–æ—á–∏—Ç–∞—Ç—å –¥–∞–ª—å—à–µ

* FRP docs ‚Äî [https://github.com/fatedier/frp](https://github.com/fatedier/frp)
* SAN vs CN –≤ OpenSSL ‚Äî [https://stackoverflow.com/questions/3112787/](https://stackoverflow.com/questions/3112787/)
* –ü–∞—Ç—Ç–µ—Ä–Ω **mTLS + token** (–≤ –∫–æ–Ω—Ñ–∏–≥–µ —É–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `auth.method = "token"`).

Happy tunnelling!üöÄ
